<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>בדיקת Counter API</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
            direction: rtl;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        .test-item {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .test-item.success {
            border-color: #4caf50;
            background: #e8f5e8;
        }
        .test-item.error {
            border-color: #f44336;
            background: #fde8e8;
        }
        .test-item.pending {
            border-color: #ff9800;
            background: #fff3e0;
        }
        .test-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .test-result {
            font-family: monospace;
            background: #f0f0f0;
            padding: 10px;
            border-radius: 3px;
            margin-top: 10px;
            white-space: pre-wrap;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #5a6fd8;
        }
        .summary {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>בדיקת Counter API Services</h1>
        <p>בדיקה זו תבדוק את כל שירותי המונה ותציג את התוצאות</p>
        
        <div class="controls">
            <button onclick="runAllTests()">הרץ את כל הבדיקות</button>
            <button onclick="clearResults()">נקה תוצאות</button>
        </div>

        <div id="test-results"></div>
        <div id="summary" class="summary" style="display: none;"></div>
    </div>

    <script>
        // Test configuration
        const TEST_SERVICES = [
            {
                name: 'CountAPI (Basic)',
                testKey: 'test-visitors',
                getUrl: (key) => `https://api.countapi.xyz/get/test-namespace/${key}`,
                hitUrl: (key) => `https://api.countapi.xyz/hit/test-namespace/${key}`,
                parseValue: (data) => data?.value,
                description: 'בדיקת CountAPI ללא אימות'
            },
            {
                name: 'CountAPI (עם הטוקן שלך)',
                testKey: 'auth-visitors',
                getUrl: (key) => `https://api.countapi.xyz/get/lia-multiplication-game-v2/${key}`,
                hitUrl: (key) => `https://api.countapi.xyz/hit/lia-multiplication-game-v2/${key}`,
                parseValue: (data) => data?.value,
                description: 'בדיקת CountAPI עם האימות שלך',
                headers: {
                    'Authorization': 'Bearer ut_Atq7mcamb6t6FQ00FYPC7rNfu1xzS5at05KRgiP7'
                }
            },
            {
                name: 'JSONBin (Public)',
                testKey: 'visitors',
                getUrl: () => `https://api.jsonbin.io/v3/b/6123456789abcdef01234567`, // Example bin
                hitUrl: () => `https://api.jsonbin.io/v3/b/6123456789abcdef01234567`,
                parseValue: (data) => data?.record?.count,
                description: 'בדיקת JSONBin (דורש הגדרה)'
            },
            {
                name: 'Simple CORS Test',
                testKey: 'cors-test',
                getUrl: () => `https://httpbin.org/json`,
                hitUrl: () => `https://httpbin.org/json`,
                parseValue: (data) => data ? 1 : 0,
                description: 'בדיקה פשוטה של CORS'
            }
        ];

        let testResults = [];

        // Helper function for fetch with timeout
        function fetchWithTimeout(url, options = {}, timeout = 5000) {
            return Promise.race([
                fetch(url, options),
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error(`Timeout after ${timeout}ms`)), timeout)
                )
            ]);
        }

        // Test a single service
        async function testService(service) {
            const testItem = createTestItem(service);
            const resultContainer = testItem.querySelector('.test-result');
            
            try {
                resultContainer.textContent = 'מתחיל בדיקה...';
                testItem.className = 'test-item pending';

                // Test GET request
                console.log(`Testing ${service.name} GET...`);
                const getOptions = service.headers ? { headers: service.headers } : {};
                const getResponse = await fetchWithTimeout(service.getUrl(service.testKey), getOptions, 3000);
                
                const getResult = {
                    status: getResponse.status,
                    ok: getResponse.ok,
                    headers: Object.fromEntries(getResponse.headers.entries())
                };

                let getData = null;
                let getValue = null;

                if (getResponse.ok) {
                    try {
                        getData = await getResponse.json();
                        getValue = service.parseValue(getData);
                    } catch (e) {
                        getData = { error: 'Failed to parse JSON', text: await getResponse.text() };
                    }
                }

                // Test HIT request (if GET worked)
                let hitResult = null;
                let hitData = null;
                if (getResponse.ok) {
                    try {
                        console.log(`Testing ${service.name} HIT...`);
                        const hitOptions = service.headers ? { headers: service.headers } : {};
                        const hitResponse = await fetchWithTimeout(service.hitUrl(service.testKey), hitOptions, 3000);
                        
                        hitResult = {
                            status: hitResponse.status,
                            ok: hitResponse.ok
                        };

                        if (hitResponse.ok) {
                            hitData = await hitResponse.json();
                        }
                    } catch (e) {
                        hitResult = { error: e.message };
                    }
                }

                // Display results
                const results = {
                    service: service.name,
                    description: service.description,
                    get: {
                        ...getResult,
                        data: getData,
                        parsedValue: getValue
                    },
                    hit: hitResult ? { ...hitResult, data: hitData } : 'לא נבדק'
                };

                resultContainer.textContent = JSON.stringify(results, null, 2);
                
                if (getResponse.ok && (getValue !== null && getValue !== undefined)) {
                    testItem.className = 'test-item success';
                    return { success: true, service: service.name, value: getValue };
                } else {
                    testItem.className = 'test-item error';
                    return { success: false, service: service.name, error: 'לא הצליח לקבל ערך תקין' };
                }

            } catch (error) {
                console.error(`Error testing ${service.name}:`, error);
                resultContainer.textContent = `שגיאה: ${error.message}\n\nפרטים נוספים:\n${error.stack || 'אין פרטים נוספים'}`;
                testItem.className = 'test-item error';
                return { success: false, service: service.name, error: error.message };
            }
        }

        function createTestItem(service) {
            const container = document.getElementById('test-results');
            const testItem = document.createElement('div');
            testItem.className = 'test-item pending';
            testItem.innerHTML = `
                <div class="test-title">${service.name}</div>
                <div>${service.description}</div>
                <div class="test-result">ממתין לבדיקה...</div>
            `;
            container.appendChild(testItem);
            return testItem;
        }

        async function runAllTests() {
            testResults = [];
            clearResults();
            
            const summary = document.getElementById('summary');
            summary.style.display = 'none';

            console.log('Starting all API tests...');

            for (const service of TEST_SERVICES) {
                const result = await testService(service);
                testResults.push(result);
                
                // Add small delay between tests
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            // Show summary
            showSummary();
        }

        function showSummary() {
            const summary = document.getElementById('summary');
            const successful = testResults.filter(r => r.success);
            const failed = testResults.filter(r => !r.success);

            let summaryText = `בדיקה הושלמה!\n\n`;
            summaryText += `✅ שירותים שעובדים: ${successful.length}\n`;
            summaryText += `❌ שירותים שלא עובדים: ${failed.length}\n\n`;

            if (successful.length > 0) {
                summaryText += `שירותים מומלצים לשימוש:\n`;
                successful.forEach(s => {
                    summaryText += `- ${s.service}${s.value !== undefined ? ` (ערך: ${s.value})` : ''}\n`;
                });
            }

            if (failed.length > 0) {
                summaryText += `\nשירותים שלא עובדים:\n`;
                failed.forEach(f => {
                    summaryText += `- ${f.service}: ${f.error}\n`;
                });
            }

            summary.textContent = summaryText;
            summary.style.display = 'block';
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
        }

        // Auto-run tests when page loads
        window.addEventListener('load', () => {
            console.log('Page loaded, starting API tests...');
            setTimeout(runAllTests, 1000);
        });
    </script>
</body>
</html>
