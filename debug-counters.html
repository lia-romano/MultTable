<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>בדיקת מונים גלובליים</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            direction: rtl;
            background: #f5f5f5;
        }
        .test-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-btn:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
        .loading {
            background: #fff3cd;
            color: #856404;
            border-color: #ffeaa7;
        }
        .counter-display {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <h1>🧪 בדיקת מונים גלובליים - משחק כפל</h1>
    
    <div class="test-card">
        <h3>📊 מונים נוכחיים</h3>
        <div class="counter-display">
            <div>🎯 מבקרים בעולם: <span id="global-visits">טוען...</span></div>
            <div style="margin-top: 10px;">📚 תרגילים בעולם: <span id="global-exercises">טוען...</span></div>
            <div style="margin-top: 10px;">👤 התרגילים שלי: <span id="personal-exercises">0</span></div>
        </div>
    </div>
    
    <div class="test-card">
        <h3>🔧 בדיקות API</h3>
        <button class="test-btn" onclick="testAllAPIs()">בדוק כל ה-APIs</button>
        <button class="test-btn" onclick="testVisitorIncrement()">הוסף מבקר</button>
        <button class="test-btn" onclick="testExerciseIncrement()">הוסף תרגיל</button>
        <button class="test-btn" onclick="refreshCounters()">רענן מונים</button>
        <div id="api-results" class="result" style="display: none;"></div>
    </div>
    
    <div class="test-card">
        <h3>💾 נתונים מקומיים</h3>
        <button class="test-btn" onclick="showLocalData()">הצג נתונים מקומיים</button>
        <button class="test-btn" onclick="clearAllData()">נקה הכל</button>
        <div id="local-results" class="result" style="display: none;"></div>
    </div>

    <script>
        // Copy the counter functions from main page
        async function updateGlobalCounter(type, increment = false) {
            const apis = [
                {
                    url: `https://api.countapi.xyz/${increment ? 'hit' : 'get'}/lia-multiplication/${type}`,
                    parse: (data) => data.value
                },
                {
                    url: `https://api.visitorbadge.io/api/${increment ? 'combined' : 'visits'}?path=lia-multiplication-${type}`,
                    parse: (data) => data.count || data.visits
                },
                {
                    url: `https://hits.dwyl.com/lia-multiplication/${type}.json`,
                    parse: (data) => data.count
                }
            ];
            
            for (const api of apis) {
                try {
                    const response = await fetch(api.url, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                    
                    if (!response.ok) continue;
                    
                    const data = await response.json();
                    const count = api.parse(data);
                    
                    if (count !== undefined && count !== null) {
                        return { count, source: api.url.split('/')[2] };
                    }
                } catch (error) {
                    continue;
                }
            }
            
            throw new Error('All APIs failed');
        }

        function getEnhancedLocalCount(type) {
            let localCount = localStorage.getItem(`local-${type}-count`) || 0;
            let baseCount = localStorage.getItem(`base-${type}-count`);
            
            if (!baseCount) {
                const daysSinceEpoch = Math.floor(Date.now() / (1000 * 60 * 60 * 24));
                if (type === 'visits') {
                    baseCount = Math.floor(daysSinceEpoch * 0.7) + Math.floor(Math.random() * 50) + 100;
                } else {
                    baseCount = Math.floor(daysSinceEpoch * 2.3) + Math.floor(Math.random() * 200) + 500;
                }
                localStorage.setItem(`base-${type}-count`, baseCount);
            }
            
            return parseInt(baseCount) + parseInt(localCount);
        }

        async function testAllAPIs() {
            const resultsDiv = document.getElementById('api-results');
            resultsDiv.style.display = 'block';
            resultsDiv.className = 'result loading';
            resultsDiv.innerHTML = 'בודק APIs...';

            const results = [];
            
            try {
                const visitResult = await updateGlobalCounter('visits', false);
                results.push(`✅ מבקרים: ${visitResult.count} (מ-${visitResult.source})`);
            } catch (error) {
                results.push(`❌ מבקרים: ${error.message}`);
            }

            try {
                const exerciseResult = await updateGlobalCounter('exercises', false);
                results.push(`✅ תרגילים: ${exerciseResult.count} (מ-${exerciseResult.source})`);
            } catch (error) {
                results.push(`❌ תרגילים: ${error.message}`);
            }

            const hasSuccess = results.some(r => r.includes('✅'));
            resultsDiv.className = hasSuccess ? 'result success' : 'result error';
            resultsDiv.innerHTML = results.join('<br>');
        }

        async function testVisitorIncrement() {
            try {
                const result = await updateGlobalCounter('visits', true);
                document.getElementById('global-visits').textContent = result.count.toLocaleString();
                showMessage('success', `מבקר נוסף! סך הכל: ${result.count}`);
            } catch (error) {
                const localCount = getEnhancedLocalCount('visits');
                localStorage.setItem('local-visits-count', parseInt(localStorage.getItem('local-visits-count') || 0) + 1);
                document.getElementById('global-visits').textContent = (localCount + 1).toLocaleString();
                showMessage('error', 'API לא זמין, נוסף מקומית');
            }
        }

        async function testExerciseIncrement() {
            try {
                const result = await updateGlobalCounter('exercises', true);
                document.getElementById('global-exercises').textContent = result.count.toLocaleString();
                showMessage('success', `תרגיל נוסף! סך הכל: ${result.count}`);
            } catch (error) {
                const localCount = getEnhancedLocalCount('exercises');
                localStorage.setItem('local-exercises-count', parseInt(localStorage.getItem('local-exercises-count') || 0) + 1);
                document.getElementById('global-exercises').textContent = (localCount + 1).toLocaleString();
                showMessage('error', 'API לא זמין, נוסף מקומית');
            }
        }

        async function refreshCounters() {
            // Personal counter
            const personalCount = localStorage.getItem('personal-exercise-count') || 0;
            document.getElementById('personal-exercises').textContent = parseInt(personalCount).toLocaleString();

            // Global counters
            try {
                const visits = await updateGlobalCounter('visits', false);
                document.getElementById('global-visits').textContent = visits.count.toLocaleString();
            } catch (error) {
                const localVisits = getEnhancedLocalCount('visits');
                document.getElementById('global-visits').textContent = localVisits.toLocaleString() + ' (מקומי)';
            }

            try {
                const exercises = await updateGlobalCounter('exercises', false);
                document.getElementById('global-exercises').textContent = exercises.count.toLocaleString();
            } catch (error) {
                const localExercises = getEnhancedLocalCount('exercises');
                document.getElementById('global-exercises').textContent = localExercises.toLocaleString() + ' (מקומי)';
            }
        }

        function showLocalData() {
            const localDiv = document.getElementById('local-results');
            localDiv.style.display = 'block';
            
            const data = {
                'personal-exercise-count': localStorage.getItem('personal-exercise-count') || '0',
                'local-visits-count': localStorage.getItem('local-visits-count') || '0',
                'local-exercises-count': localStorage.getItem('local-exercises-count') || '0',
                'base-visits-count': localStorage.getItem('base-visits-count') || 'לא נוצר',
                'base-exercises-count': localStorage.getItem('base-exercises-count') || 'לא נוצר',
                'last-global-visits': localStorage.getItem('last-global-visits') || 'אין',
                'last-global-exercises': localStorage.getItem('last-global-exercises') || 'אין'
            };

            let html = '<strong>נתונים ב-localStorage:</strong><br><br>';
            for (const [key, value] of Object.entries(data)) {
                html += `<strong>${key}:</strong> ${value}<br>`;
            }

            localDiv.className = 'result success';
            localDiv.innerHTML = html;
        }

        function clearAllData() {
            if (confirm('האם אתה בטוח שברצונך לנקות את כל הנתונים המקומיים?')) {
                localStorage.clear();
                document.getElementById('global-visits').textContent = 'טוען...';
                document.getElementById('global-exercises').textContent = 'טוען...';
                document.getElementById('personal-exercises').textContent = '0';
                showMessage('success', 'כל הנתונים נוקו');
            }
        }

        function showMessage(type, message) {
            const div = document.getElementById('api-results');
            div.style.display = 'block';
            div.className = `result ${type}`;
            div.innerHTML = message;
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            refreshCounters();
        });
    </script>
</body>
</html>
